# .github/workflows/deploy.yml
name: Deploy to dev VM (self-hosted)

on:
  push:
    branches: [develop]
  workflow_dispatch:

permissions:
  contents: read
  packages: read # needed to pull from GHCR with GITHUB_TOKEN

jobs:
  deploy:
    runs-on: [self-hosted, Linux, modjot-dev]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Create .env from repo vars/secrets
        run: |
          cat > .env <<'EOF'
          APP_ENV=${{ vars.APP_ENV || 'dev' }}
          FIBER_HOST=${{ vars.FIBER_HOST || '0.0.0.0' }}
          FIBER_PORT=${{ vars.FIBER_PORT || '8081' }}

          POSTGRES_HOST=${{ vars.POSTGRES_HOST || 'postgres-db' }}
          POSTGRES_PORT=${{ vars.POSTGRES_PORT || '5432' }}
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB=${{ vars.POSTGRES_DB || 'modjot' }}
          POSTGRES_PROTOCOL=${{ vars.POSTGRES_PROTOCOL || 'tcp' }}
          POSTGRES_SSL_MODE=${{ vars.POSTGRES_SSL_MODE || 'disable' }}
          
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}

          ACCESS_TOKEN_SECRET=${{ secrets.ACCESS_TOKEN_SECRET }}
          REFRESH_TOKEN_SECRET=${{ secrets.REFRESH_TOKEN_SECRET }}
          ACCESS_TOKEN_TTL=${{ vars.ACCESS_TOKEN_TTL || '30m' }}
          REFRESH_TOKEN_TTL=${{ vars.REFRESH_TOKEN_TTL || '720h' }}
          JWT_ISSUER=${{ vars.JWT_ISSUER || 'modjot' }}

          PGADMIN_DEFAULT_EMAIL=${{ secrets.PGADMIN_DEFAULT_EMAIL }}
          PGADMIN_DEFAULT_PASSWORD=${{ secrets.PGADMIN_DEFAULT_PASSWORD }}
          PGADMIN_PORT=${{ vars.PGADMIN_PORT || '5050' }}
          PGADMIN_CONFIG_SESSION_EXPIRATION_TIME=${{ vars.PGADMIN_CONFIG_SESSION_EXPIRATION_TIME || '1800' }}
          PGADMIN_CONFIG_MAX_SESSION_IDLE_TIME=${{ vars.PGADMIN_CONFIG_MAX_SESSION_IDLE_TIME || '1800' }}

          AI_WRAPPER_ADDR=${{ vars.AI_WRAPPER_ADDR || 'ai-wrapper-service:50051' }}
          HTTP_ADDR=${{ vars.HTTP_ADDR || ':8081' }}
          GRPC_ADDR=${{ vars.GRPC_ADDR || ':50051' }}
          OPENTYPHOON_API_KEY=${{ secrets.OPENTYPHOON_API_KEY }}
          OLLAMA_PORT=${{ vars.OLLAMA_PORT || '11434' }}

          KONG_DATABASE=${{ vars.KONG_DATABASE || 'off' }}
          KONG_DECLARATIVE_CONFIG=${{ vars.KONG_DECLARATIVE_CONFIG || '/etc/kong/kong.yml' }}
          KONG_PROXY_LISTEN=${{ vars.KONG_PROXY_LISTEN || '0.0.0.0:8000,0.0.0.0:8443 ssl' }}
          KONG_ADMIN_LISTEN=${{ vars.KONG_ADMIN_LISTEN || '0.0.0.0:8001' }}
          KONG_NGINX_HTTP_CLIENT_MAX_BODY_SIZE=${{ vars.KONG_NGINX_HTTP_CLIENT_MAX_BODY_SIZE || '100m' }}
          HOST_IP=${{ secrets.HOST_IP }}

          REDIS_PORT=${{ vars.REDIS_PORT || '6379' }}
          REDIS_ADDR=${{ vars.REDIS_ADDR || 'redis:6379' }}
          UPLOAD_DIR=${{ vars.UPLOAD_DIR || './uploads' }}
          EOF

      - name: Stage deploy files
        run: |
          mkdir -p /modjot/kong /modjot/db/init /modjot/db/migrations
          cp -f .env docker-compose.dev.yml /modjot/
          cp -f kong/kong.yml /modjot/kong/
          cp -f db/init/* /modjot/db/init/
          cp -f db/migrations/* /modjot/db/migrations/

      - name: Login to GHCR
        env:
          CR_PAT: ${{ secrets.GHCR_READ_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "$CR_PAT" ]; then
            echo "$CR_PAT" | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin
          fi

      - name: Pull images
        working-directory: /modjot
        run: |
          docker compose -f docker-compose.dev.yml pull

      - name: Run DB migrations
        working-directory: /modjot
        run: |
          docker compose -f docker-compose.dev.yml up --abort-on-container-exit migrate

      - name: Clean migrate container
        working-directory: /modjot
        run: |
          docker compose -f docker-compose.dev.yml rm -f migrate || true

      - name: Deploy application services
        working-directory: /modjot
        run: |
          docker compose -f docker-compose.dev.yml up -d \
            postgres-db \
            redis \
            ai-service \
            main-service \
            worker-service \
            kong

      - name: Cleanup old images
        run: |
          docker image prune -af --filter "until=72h" || true
